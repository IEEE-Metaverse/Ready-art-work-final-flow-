<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Website Analysis Results</h1>
            <a href="/" class="back-btn">‚Üê Analyze More Websites</a>
        </div>

        <div class="results-table-container">
            <table class="results-table">
                <thead>
                    <tr>
                        <th class="criteria-column">Criteria</th>
                        {% for result in results %}
                        {% if result.status == 'success' %}
                        <th class="website-column">
                            <div class="website-header">
                                <div class="company-name">{{ get_company_name(result.url) }}</div>
                                <div class="website-url">
                                    <a href="{{ result.url }}" target="_blank">{{ result.url }}</a>
                                </div>
                                <div class="status-badge status-{{ result.status }}">
                                    {{ result.status.upper() }}
                                </div>
                            </div>
                        </th>
                        {% else %}
                        <th class="website-column">
                            <div class="website-header">
                                <div class="company-name">{{ get_company_name(result.url) }}</div>
                                <div class="website-url">
                                    <a href="{{ result.url }}" target="_blank">{{ result.url }}</a>
                                </div>
                                <div class="status-badge status-error">
                                    ERROR
                                </div>
                            </div>
                        </th>
                        {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Overall Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Overall Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_overall_score(result.content) or 'N/A' }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Website Description Row -->
                    <tr>
                        <td class="criteria-label">Description of Website</td>
                        {% for result in results %}
                        <td class="description-cell">
                            {% if result.status == 'success' %}
                                <div class="description-text">{{ extract_website_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">{{ result.error or 'Analysis failed' }}</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Audience Perspective / Consumer Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Audience Perspective</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_audience_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_audience_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Developer Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Developer Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_developer_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_developer_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Investor Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Investor Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_investor_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_investor_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Technical Criteria Scores Row -->
                    <tr class="section-header">
                        <td class="criteria-label">Technical Criteria Scores</td>
                        {% for result in results %}
                        <td class="section-cell">{{ extract_technical_header(result.content) }}</td>
                        {% endfor %}
                    </tr>

                    <!-- Clarity Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Clarity Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_clarity_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_clarity_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Visual Design Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Visual Design Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_visual_design_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_visual_design_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- UX Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">UX Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_ux_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_ux_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Trust Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Trust Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_trust_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_trust_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>

                    <!-- Value Prop Score Row -->
                    <tr class="score-row">
                        <td class="criteria-label">Value Prop Score</td>
                        {% for result in results %}
                        <td class="score-cell">
                            {% if result.status == 'success' %}
                                <div class="score-number">{{ extract_value_prop_score(result.content) or 'N/A' }}</div>
                                <div class="score-description">{{ extract_value_prop_description(result.content) }}</div>
                            {% else %}
                                <div class="error-cell">Error</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Raw Data Section (Collapsible) -->
        <div class="raw-data-section">
            <button onclick="toggleRawData()" class="toggle-btn">Show Raw Analysis Data</button>
            <div id="rawDataContainer" class="raw-data-container" style="display: none;">
                {% for result in results %}
                <div class="raw-data-card">
                    <h3>{{ result.url }}</h3>
                    {% if result.status == 'success' %}
                    <pre class="raw-content">{{ result.content }}</pre>
                    {% else %}
                    <div class="error-content">
                        <p><strong>Error:</strong> {{ result.error or 'Unknown error occurred' }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="downloadExcel()" class="download-btn primary">Download this Data</button>
            <button onclick="window.print()" class="print-btn secondary">Print Results</button>
        </div>
    </div>

    <!-- Store data safely in a script tag -->
<!-- Store data safely in a script tag -->
<script type="application/json" id="results-data">{{ results | tojson }}</script>

<script>
    function toggleRawData() {
        const container = document.getElementById('rawDataContainer');
        const button = document.querySelector('.toggle-btn');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            button.textContent = 'Hide Raw Analysis Data';
        } else {
            container.style.display = 'none';
            button.textContent = 'Show Raw Analysis Data';
        }
    }

    function downloadExcel() {
        try {
            // Get the raw results data for detailed content
            const dataElement = document.getElementById('results-data');
            const resultsData = JSON.parse(dataElement.textContent);
            
            // Get the table for structure
            const table = document.querySelector('.results-table');
            let csvContent = '';
            
            // Add BOM for proper Excel UTF-8 support
            csvContent = '\uFEFF';
            
            // Extract headers (company names)
            const headers = ['Criteria'];
            const headerCells = table.querySelectorAll('thead th:not(:first-child)');
            headerCells.forEach(function(cell) {
                const companyName = cell.querySelector('.company-name');
                if (companyName) {
                    headers.push('"' + companyName.textContent.trim() + '"');
                }
            });
            csvContent += headers.join(',') + '\n';
            
            // Add URL row
            let urlRow = ['"URL"'];
            resultsData.forEach(function(result) {
                urlRow.push('"' + result.url + '"');
            });
            csvContent += urlRow.join(',') + '\n';
            
            // Add Status row
            let statusRow = ['"Status"'];
            resultsData.forEach(function(result) {
                statusRow.push('"' + result.status.toUpperCase() + '"');
            });
            csvContent += statusRow.join(',') + '\n';
            
            // Extract detailed data for each criteria
            const criteriaRows = [
                {
                    label: 'Overall Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'overall') || 'N/A';
                    }
                },
                {
                    label: 'Description of Website',
                    extractor: function(content) {
                        return extractDetailedDescription(content);
                    }
                },
                {
                    label: 'Audience Perspective Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'consumer') || extractDetailedScore(content, 'audience') || 'N/A';
                    }
                },
                {
                    label: 'Audience Perspective Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'audience perspective') || extractSectionDescription(content, 'consumer');
                    }
                },
                {
                    label: 'Developer Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'developer') || 'N/A';
                    }
                },
                {
                    label: 'Developer Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'developer');
                    }
                },
                {
                    label: 'Investor Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'investor') || 'N/A';
                    }
                },
                {
                    label: 'Investor Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'investor');
                    }
                },
                {
                    label: 'Technical Criteria Scores',
                    extractor: function(content) {
                        return 'Technical Criteria Scores';
                    }
                },
                {
                    label: 'Clarity Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'clarity') || 'N/A';
                    }
                },
                {
                    label: 'Clarity Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'clarity');
                    }
                },
                {
                    label: 'Visual Design Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'visual design') || extractDetailedScore(content, 'design') || 'N/A';
                    }
                },
                {
                    label: 'Visual Design Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'visual design') || extractSectionDescription(content, 'design');
                    }
                },
                {
                    label: 'UX Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'ux') || extractDetailedScore(content, 'user experience') || 'N/A';
                    }
                },
                {
                    label: 'UX Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'ux') || extractSectionDescription(content, 'user experience');
                    }
                },
                {
                    label: 'Trust Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'trust') || 'N/A';
                    }
                },
                {
                    label: 'Trust Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'trust');
                    }
                },
                {
                    label: 'Value Prop Score',
                    extractor: function(content) {
                        return extractDetailedScore(content, 'value prop') || extractDetailedScore(content, 'value') || 'N/A';
                    }
                },
                {
                    label: 'Value Prop Description',
                    extractor: function(content) {
                        return extractSectionDescription(content, 'value') || extractSectionDescription(content, 'proposition');
                    }
                }
            ];
            
            // Add each criteria row
            criteriaRows.forEach(function(criteria) {
                let row = ['"' + criteria.label + '"'];
                resultsData.forEach(function(result) {
                    if (result.status === 'success') {
                        let value = criteria.extractor(result.content);
                        // Clean and escape the value for CSV
                        if (value && value !== 'N/A') {
                            value = value.replace(/"/g, '""'); // Escape quotes
                            value = value.replace(/\n/g, ' '); // Replace newlines with spaces
                            value = value.replace(/\s+/g, ' ').trim(); // Clean up whitespace
                        }
                        row.push('"' + (value || '') + '"');
                    } else {
                        row.push('"Error: ' + (result.error || 'Analysis failed') + '"');
                    }
                });
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download the file
            const blob = new Blob([csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.getFullYear() + 
                            (now.getMonth() + 1).toString().padStart(2, '0') + 
                            now.getDate().toString().padStart(2, '0') + '_' +
                            now.getHours().toString().padStart(2, '0') + 
                            now.getMinutes().toString().padStart(2, '0');
            
            link.setAttribute('download', 'Website_Analysis_Results_Detailed_' + timestamp + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            console.error('Error downloading Excel file:', error);
            alert('Error downloading file: ' + error.message);
        }
    }

    // Helper functions to extract detailed content
    function extractDetailedScore(text, scoreType) {
        if (!text) return null;
        
        const textLower = text.toLowerCase();
        const patterns = [
            new RegExp(scoreType + '[:\\s]*(\\d+\\.?\\d*)', 'i'),
            new RegExp(scoreType + '\\s*score[:\\s]*(\\d+\\.?\\d*)', 'i'),
            new RegExp('(\\d+\\.?\\d*)\\s*' + scoreType, 'i')
        ];
        
        for (let pattern of patterns) {
            const match = textLower.match(pattern);
            if (match) {
                return match[1];
            }
        }
        return null;
    }

    function extractDetailedDescription(text) {
        if (!text) return "Analysis completed";
        
        const lines = text.split('\n');
        
        // Look for substantial description content
        for (let line of lines) {
            line = line.trim();
            if (line.length > 30 && 
                !line.toLowerCase().match(/^(score|rating|\d+\.?\d*$|home|analyze|scoreboard)/)) {
                return line;
            }
        }
        
        return "Website analysis completed";
    }

    function extractSectionDescription(text, sectionKeyword) {
        if (!text) return "";
        
        const lines = text.split('\n');
        let foundSection = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.toLowerCase().includes(sectionKeyword)) {
                foundSection = true;
                
                // Look for description in current line after colon
                if (line.includes(':')) {
                    const desc = line.split(':', 1)[1]?.trim();
                    if (desc && desc.length > 15) {
                        return desc;
                    }
                }
                
                // Look in next few lines
                for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
                    const nextLine = lines[j].trim();
                    if (nextLine.length > 20 && 
                        !nextLine.toLowerCase().match(/^(score|rating|\d+\.?\d*$)/)) {
                        return nextLine;
                    }
                }
            }
        }
        
        return "";
    }

    function downloadResults() {
        // Fallback text download
        try {
            const dataElement = document.getElementById('results-data');
            const websiteResults = JSON.parse(dataElement.textContent);
            
            let content = 'Website Analysis Results\n';
            content += '========================\n\n';
            
            websiteResults.forEach(function(result, index) {
                content += 'Website ' + (index + 1) + ': ' + result.url + '\n';
                content += 'Status: ' + result.status.toUpperCase() + '\n';
                if (result.status === 'success') {
                    content += 'Content:\n' + result.content + '\n';
                } else {
                    content += 'Error: ' + result.error + '\n';
                }
                content += '\n' + '-'.repeat(50) + '\n\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'website_analysis_results.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
        } catch (error) {
            alert('Error downloading results: ' + error.message);
        }
    }
</script>
</body>
</html>
